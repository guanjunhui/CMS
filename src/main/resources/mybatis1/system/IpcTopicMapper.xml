<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="IpcTopicMapper">
	<!-- 根据id查找我发表的话题列表 -->	<select id="getMyTopicByUserIdlistPage" parameterType="pd" resultType="hashmap">		SELECT			WT.id,			WT.title,			WT.detail,			WT.pageviews,			WT.state,			WT.is_close isClose,			(select count(*) from WEB_TOPIC_REPLY WTA where WT.id=WTA.topic_id) replyCount,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC WT		WHERE			WT.user_id=#{pd.userId}			ORDER BY			WT.create_time DESC	</select>		<!-- 根据话题id查询话题详情 -->	<select id="detailById" parameterType="string" resultType="hashmap">		SELECT			WT.id,			WT.title,			WT.detail,			WT.pageviews,			WT.state,			(select count(*) from WEB_TOPIC_REPLY WTA where WT.id=WTA.topic_id) replyCount,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC WT		WHERE			WT.id=#{id}		</select>			<!-- 查询热门话题列表 -->	<select id="getHotlistPage" parameterType="pd" resultType="hashmap">		SELECT			WT.id,			WT.title,			WT.detail,			WT.pageviews,			WT.state,			(select count(*) from WEB_TOPIC_REPLY WTA where WT.id=WTA.topic_id) replyCount,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC WT		ORDER BY			WT.pageviews DESC,			WT.create_time DESC	</select>		<!-- 根据id查询话题详情 -->	<select id="getTopicById" parameterType="String" resultType="hashmap">		SELECT			WT.id,			WT.title,			WT.detail,			WT.pageviews,			WT.state,			WT.user_id userId,			WT.is_close isClose,			(select count(*) from WEB_TOPIC_REPLY WTA where WT.id=WTA.topic_id) replyCount,			<if test="userId != null and userId != ''">				(select count(*) from WEB_COLLECTION WC WHERE WT.id=WC.source_id and WC.source_type=2 and WT.user_id=#{userId}) isCol,			</if>			(select count(*) from WEB_COLLECTION WC where WC.source_id=WT.id and WC.source_type=2) collCount,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC WT		WHERE			WT.id=#{topicId}	</select>		<!-- 查询所有话题列表 -->	<select id="getAlllistPage" parameterType="pd" resultType="hashmap">		SELECT			WT.id,			WT.title,			WT.detail,			WT.pageviews,			WT.state,			WT.user_id userId,			WT.is_close isClose,			(select count(*) from WEB_TOPIC_REPLY WTA where WT.id=WTA.topic_id) replyCount,			<if test="userId != null and userId != ''">				(select count(*) from WEB_COLLECTION WC WHERE WT.id=WC.source_id and WC.source_type=2 and WT.user_id=#{userId}) isCol,			</if>			(select count(*) from WEB_COLLECTION WC where WC.source_id=WT.id and WC.source_type=2) collCount,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC WT		<where>			<if test="isClose!=null and isClose!=''">				WT.is_close = #{isClose} and 			</if>			<if test="isSolve!=null and isSolve!=''">				WT.state = #{isSolve} and 			</if>			WT.title like CONCAT('%','${text}','%' )		</where>			<!-- 关注度 -->			<if test="queryKey == 1">				ORDER BY					pageviews 					<if test="time == 1">						DESC					</if>			</if>			<!-- 发布时间 -->			<if test="queryKey == 2">				ORDER BY					createTime				<if test="time == 1">					DESC				</if>			</if>			<if test="queryKey == '' or queryKey == null">				ORDER BY					createTime					DESC			</if>	</select>	<!-- 发表话题 -->	<insert id="saveTopic" parameterType="pd">		insert into			WEB_TOPIC(id,title,detail,user_id)		values			(#{id},#{title},#{detail},#{userId})	</insert>		<!-- 保存话题评论 -->	<insert id="saveTopicReply" parameterType="pd">		insert into			WEB_TOPIC_REPLY(id,topic_id,parent_id,touser_id,user_id,reply)		values			(#{id},#{topicId},#{parentId},#{touserId},#{userId},#{reply})	</insert>		<!-- 查询话题一级回答列表 -->	<select id="getReplylistPage" parameterType="pd" resultType="hashmap">		select			WTR.id,			WTR.topic_id topicId,			WTR.parent_id parentId,			WTR.touser_id touserId,			WTR.user_id userId,			WTR.is_adopt isAdopt,			DATE_FORMAT(WTR.create_time,'%Y-%m-%d %H:%i') AS createTime,			WTR.reply		from			WEB_TOPIC_REPLY WTR		WHERE			WTR.topic_id=#{queryKey} and parent_id = '0'		order by WTR.create_time desc	</select>		<!-- 查询话题二级回答列表 -->	<select id="getReply2List" parameterType="pd" resultType="hashmap">		select			WTR.id,			WTR.topic_id topicId,			WTR.parent_id parentId,			WTR.touser_id touserId,			WTR.user_id userId,			WT.user_id topicUserId,			WTR.reply		from			WEB_TOPIC_REPLY WTR		left join WEB_TOPIC WT on WTR.topic_id=WT.id 		WHERE			WTR.parent_id=#{queryKey} and WTR.parent_id != '0'		order by WTR.create_time desc	</select>		<!-- 查询话题所有回答列表 -->	<select id="getAllReplylistPage" parameterType="pd" resultType="hashmap">		select			WTR.id,			WTR.topic_id topicId,			WTR.parent_id parentId,			WTR.touser_id touserId,			WTR.user_id userId,			WTR.is_adopt isAdopt,			DATE_FORMAT(WTR.create_time,'%Y-%m-%d %H:%i') AS createTime,			WTR.reply		from			WEB_TOPIC_REPLY WTR		WHERE			WTR.topic_id=#{queryKey}		order by WTR.create_time desc	</select>		<!-- 修改话题浏览量 -->	<update id="updatePageViews" parameterType="string">		UPDATE			WEB_TOPIC		SET			pageviews = pageviews + 1		WHERE			id=#{topicId}	</update>		<!-- 根据话题id设置最佳回复 -->	<update id="setAdoptReply" parameterType="pd">		UPDATE			WEB_TOPIC_REPLY		SET			is_adopt = 1		WHERE			id=#{replyId}	</update>		<!-- 关闭话题，并设置话题是否解决 -->	<update id="closeTopic" parameterType="pd">		update			WEB_TOPIC		set			is_close = 1,state = #{state}		where			id = #{topicId}	</update>		<!-- 根据用户id查询其回答的话题列表 -->	<select id="getMyAnswerTopiclistPage" parameterType="pd" resultType="hashmap">		select 			WT.id,			WT.title,			WT.detail,			DATE_FORMAT(WT.create_time,'%Y-%m-%d %H:%i') AS createTime		FROM			WEB_TOPIC_REPLY WTR		INNER join WEB_TOPIC WT ON WTR.user_id=#{userId} and WTR.topic_id=WT.id		GROUP BY			WT.id		ORDER BY			WT.create_time DESC	</select>		<!-- 根据话题id和userId查询我的回答 -->	<select id="getMyReplyByUserIdAndTopicId" parameterType="hashmap" resultType="hashmap">		select			WTR.reply		from			WEB_TOPIC_REPLY WTR		where			WTR.topic_id = #{topicId} and WTR.user_id = #{userId}		</select>		<!-- 根据id删除话题 -->	<delete id="deleteById" parameterType="pd">		delete from		WEB_TOPIC		where id = #{id}	</delete>	<!-- 根据id删除话题回复 -->	<delete id="deleteReplyByTipicId" parameterType="pd">		delete from		WEB_TOPIC_REPLY		where topic_id = #{id}	</delete>	<!-- 根据话题id删除话题点赞 -->	<delete id="deleteThumbByTipicId" parameterType="pd">		delete from		WEB_THUMB		where source_id = #{id} AND source_type = '2'	</delete>	<!-- 根据话题id删除话题收藏 -->	<delete id="deleteCollByTipicId" parameterType="pd">		delete from		WEB_COLLECTION		where source_id = #{id} AND source_type = '2'	</delete>	<!-- 根据回复id删除话题回复 -->	<delete id="deleteReplyById" parameterType="pd">		delete from		WEB_TOPIC_REPLY		where id = #{id}	</delete>		<!-- 定时扫描话题 -->	<select id="scanTopic" resultType="hashmap">		select 			id,			title,			DATE_FORMAT(create_time,'%Y-%m-%d') AS createTime		from			WEB_TOPIC		where			DATE_SUB(CURDATE(), INTERVAL 3 DAY) &gt;= date(create_time)	</select></mapper>